name: Fix Network Connectivity

on:
  workflow_dispatch:

jobs:
  fix-connectivity:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Fix Network ACLs for VPC Communication
      run: |
        echo "üîß Corrigindo Network ACLs para permitir comunica√ß√£o interna na VPC..."
        
        # Obter as NACLs das subnets
        echo "üìã Obtendo Network ACLs das subnets..."
        NACL_IDS=$(aws ec2 describe-subnets --subnet-ids subnet-07fe020cefc4bd241 subnet-08d34ed68511f3917 --query 'Subnets[*].NetworkAclAssociations[*].NetworkAclId' --output text | tr '\t' ' ' | tr '\n' ' ')
        
        for nacl_id in $NACL_IDS; do
          if [ ! -z "$nacl_id" ]; then
            echo "üõ†Ô∏è Configurando NACL: $nacl_id"
            
            # Verificar se √© a NACL padr√£o
            IS_DEFAULT=$(aws ec2 describe-network-acls --network-acl-ids $nacl_id --query 'NetworkAcls[0].IsDefault' --output text)
            
            if [ "$IS_DEFAULT" = "True" ]; then
              echo "‚úÖ NACL padr√£o detectada - j√° deve permitir todo tr√°fego interno"
            else
              echo "‚ö†Ô∏è NACL customizada detectada - adicionando regras de conectividade"
              
              # Adicionar regra ALLOW para tr√°fego MySQL (3306) de entrada
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 100 \
                --protocol tcp \
                --rule-action allow \
                --port-range From=3306,To=3306 \
                --cidr-block 172.31.0.0/16 \
                --ingress || echo "Regra de ingresso j√° existe ou erro"
              
              # Adicionar regra ALLOW para tr√°fego MySQL (3306) de sa√≠da  
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 100 \
                --protocol tcp \
                --rule-action allow \
                --port-range From=3306,To=3306 \
                --cidr-block 172.31.0.0/16 \
                --egress || echo "Regra de egresso j√° existe ou erro"
              
              # Adicionar regra ALLOW para todo tr√°fego TCP interno da VPC (ingresso)
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 200 \
                --protocol tcp \
                --rule-action allow \
                --port-range From=0,To=65535 \
                --cidr-block 172.31.0.0/16 \
                --ingress || echo "Regra de ingresso TCP j√° existe ou erro"
              
              # Adicionar regra ALLOW para todo tr√°fego TCP interno da VPC (egresso)
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 200 \
                --protocol tcp \
                --rule-action allow \
                --port-range From=0,To=65535 \
                --cidr-block 172.31.0.0/16 \
                --egress || echo "Regra de egresso TCP j√° existe ou erro"
              
              # Adicionar regra ALLOW para ICMP (ping) interno da VPC (ingresso)
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 300 \
                --protocol icmp \
                --rule-action allow \
                --icmp-type-code Code=-1,Type=-1 \
                --cidr-block 172.31.0.0/16 \
                --ingress || echo "Regra ICMP de ingresso j√° existe ou erro"
              
              # Adicionar regra ALLOW para ICMP (ping) interno da VPC (egresso)
              aws ec2 create-network-acl-entry \
                --network-acl-id $nacl_id \
                --rule-number 300 \
                --protocol icmp \
                --rule-action allow \
                --icmp-type-code Code=-1,Type=-1 \
                --cidr-block 172.31.0.0/16 \
                --egress || echo "Regra ICMP de egresso j√° existe ou erro"
            fi
            
            echo ""
            echo "üìã Regras atuais da NACL $nacl_id:"
            aws ec2 describe-network-acls --network-acl-ids $nacl_id --query 'NetworkAcls[0].Entries' --output table
            echo ""
          fi
        done
        
        echo "‚úÖ Configura√ß√£o das NACLs conclu√≠da!"
        echo "üîÑ Aguarde alguns minutos para que as altera√ß√µes sejam propagadas na AWS."